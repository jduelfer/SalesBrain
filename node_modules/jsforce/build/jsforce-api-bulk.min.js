/*! jsforce - v1.5.1 - 2016-01-14 */
!function(a){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=a();else if("function"==typeof define&&define.amd)define([],a);else{var b;b="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:this,b=b.jsforce||(b.jsforce={}),b=b.modules||(b.modules={}),b=b.api||(b.api={}),b.Bulk=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);var j=new Error("Cannot find module '"+g+"'");throw j.code="MODULE_NOT_FOUND",j}var k=c[g]={exports:{}};b[g][0].call(k.exports,function(a){var c=b[g][1][a];return e(c?c:a)},k,k.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b,c){(function(a){"use strict";var c=jsforce.require("inherits"),d=jsforce.require("readable-stream"),e=d.Duplex,f=jsforce.require("events"),g=jsforce.require("underscore"),h=jsforce.require("./record-stream"),i=(jsforce.require("./csv"),jsforce.require("./promise")),j=jsforce.require("./http-api"),k=function(a,b,c,d,e){this._bulk=a,this.type=b,this.operation=c,this.options=d||{},this.id=e,this.state=this.id?"Open":"Unknown",this._batches={}};c(k,f.EventEmitter),k.prototype.info=function(a){return this._jobInfo||(this._jobInfo=this.check()),this._jobInfo.thenCall(a)},k.prototype.open=function(a){var b=this,c=this._bulk;c._logger;if(!this._jobInfo){var d=this.operation.toLowerCase();"harddelete"===d&&(d="hardDelete");var e=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo  xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<operation>"+d+"</operation>","<object>"+this.type+"</object>",this.options.extIdField?"<externalIdFieldName>"+this.options.extIdField+"</externalIdFieldName>":"",this.options.concurrencyMode?"<concurrencyMode>"+this.options.concurrencyMode+"</concurrencyMode>":"",this.options.assignmentRuleId?"<assignmentRuleId>"+this.options.assignmentRuleId+"</assignmentRuleId>":"","<contentType>CSV</contentType>","</jobInfo>"].join("");this._jobInfo=c._request({method:"POST",path:"/job",body:e,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"}).then(function(a){return b.emit("open",a.jobInfo),b.id=a.jobInfo.id,b.state=a.jobInfo.state,a.jobInfo},function(a){throw b.emit("error",a),a})}return this._jobInfo.thenCall(a)},k.prototype.createBatch=function(){var a=new l(this),b=this;return a.on("queue",function(){b._batches[a.id]=a}),a},k.prototype.batch=function(a){var b=this._batches[a];return b||(b=new l(this,a),this._batches[a]=b),b},k.prototype.check=function(a){var b=this,c=this._bulk,d=c._logger;return this._jobInfo=this._waitAssign().then(function(){return c._request({method:"GET",path:"/job/"+b.id,responseType:"application/xml"})}).then(function(a){return d.debug(a.jobInfo),b.id=a.jobInfo.id,b.type=a.jobInfo.object,b.operation=a.jobInfo.operation,b.state=a.jobInfo.state,a.jobInfo}),this._jobInfo.thenCall(a)},k.prototype._waitAssign=function(a){return(this.id?i.resolve({id:this.id}):this.open()).thenCall(a)},k.prototype.list=function(a){var b=this,c=this._bulk,d=c._logger;return this._waitAssign().then(function(){return c._request({method:"GET",path:"/job/"+b.id+"/batch",responseType:"application/xml"})}).then(function(a){d.debug(a.batchInfoList.batchInfo);var b=a.batchInfoList;return b=g.isArray(b.batchInfo)?b.batchInfo:[b.batchInfo]}).thenCall(a)},k.prototype.close=function(){var a=this;return this._changeState("Closed").then(function(b){return a.id=null,a.emit("close",b),b},function(b){throw a.emit("error",b),b})},k.prototype.abort=function(){var a=this;return this._changeState("Aborted").then(function(b){return a.id=null,a.emit("abort",b),b},function(b){throw a.emit("error",b),b})},k.prototype._changeState=function(a,b){var c=this,d=this._bulk,e=d._logger;return this._jobInfo=this._waitAssign().then(function(){var b=['<?xml version="1.0" encoding="UTF-8"?>','<jobInfo xmlns="http://www.force.com/2009/06/asyncapi/dataload">',"<state>"+a+"</state>","</jobInfo>"].join("");return d._request({method:"POST",path:"/job/"+c.id,body:b,headers:{"Content-Type":"application/xml; charset=utf-8"},responseType:"application/xml"})}).then(function(a){return e.debug(a.jobInfo),c.state=a.jobInfo.state,a.jobInfo}),this._jobInfo.thenCall(b)};var l=function(a,b){l.super_.call(this,{objectMode:!0}),this.job=a,this.id=b,this._bulk=a._bulk,this._deferred=i.defer(),this._setupDataStreams()};c(l,d.Writable),l.prototype._setupDataStreams=function(){var a=this,b={nullValue:"#N/A"};this._uploadStream=new h.Serializable,this._uploadDataStream=this._uploadStream.stream("csv",b),this._downloadStream=new h.Parsable,this._downloadDataStream=this._downloadStream.stream("csv",b),this.on("finish",function(){a._uploadStream.end()}),this._uploadDataStream.once("readable",function(){a.job.open().then(function(){a._uploadDataStream.pipe(a._createRequestStream())})});var c=this._dataStream=new e;c._write=function(b,c,d){a._uploadDataStream.write(b,c,d)},c.on("finish",function(){a._uploadDataStream.end()}),this._downloadDataStream.on("readable",function(){c.read(0)}),this._downloadDataStream.on("end",function(){c.push(null)}),c._read=function(b){for(var d;null!==(d=a._downloadDataStream.read());)c.push(d)}},l.prototype._createRequestStream=function(){var a=this,b=a._bulk,c=b._logger;return b._request({method:"POST",path:"/job/"+a.job.id+"/batch",headers:{"Content-Type":"text/csv"},responseType:"application/xml"},function(b,d){b?a.emit("error",b):(c.debug(d.batchInfo),a.id=d.batchInfo.id,a.emit("queue",d.batchInfo))}).stream()},l.prototype._write=function(a,b,c){a=g.clone(a),"insert"===this.job.operation?delete a.Id:"delete"===this.job.operation&&(a={Id:a.Id}),delete a.type,delete a.attributes,this._uploadStream.write(a,b,c)},l.prototype.stream=function(){return this._dataStream},l.prototype.run=l.prototype.exec=l.prototype.execute=function(a,b){var c=this;if("function"==typeof a&&(b=a,a=null),this._result)throw new Error("Batch already executed.");var d=i.defer();if(this._result=d.promise,this._result.then(function(a){c._deferred.resolve(a)},function(a){c._deferred.reject(a)}),this.once("response",function(a){d.resolve(a)}),this.once("error",function(a){d.reject(a)}),g.isObject(a)&&g.isFunction(a.pipe))a.pipe(this._dataStream);else{var e;g.isArray(a)?(g.forEach(a,function(a){c.write(a)}),c.end()):g.isString(a)&&(e=a,this._dataStream.write(e,"utf8"),this._dataStream.end())}return this.thenCall(b)},l.prototype.then=function(a,b,c){return this._deferred.promise.then(a,b,c)},l.prototype.thenCall=function(b){return g.isFunction(b)&&this.then(function(c){a.nextTick(function(){b(null,c)})},function(c){a.nextTick(function(){b(c)})}),this},l.prototype.check=function(a){var b=this._bulk,c=b._logger,d=this.job.id,e=this.id;if(!d||!e)throw new Error("Batch not started.");return b._request({method:"GET",path:"/job/"+d+"/batch/"+e,responseType:"application/xml"}).then(function(a){return c.debug(a.batchInfo),a.batchInfo}).thenCall(a)},l.prototype.poll=function(a,b){var c=this,d=this.job.id,e=this.id;if(!d||!e)throw new Error("Batch not started.");var f=(new Date).getTime(),g=function(){var h=(new Date).getTime();if(h>f+b){var i=new Error("Polling time out. Job Id = "+d+" , batch Id = "+e);return i.name="PollingTimeout",void c.emit("error",i)}c.check(function(b,d){b?c.emit("error",b):"Failed"===d.state?parseInt(d.numberRecordsProcessed,10)>0?c.retrieve():c.emit("error",new Error(d.stateMessage)):"Completed"===d.state?c.retrieve():(c.emit("progress",d),setTimeout(g,a))})};setTimeout(g,a)},l.prototype.retrieve=function(a){var b=this,c=this._bulk,d=this.job.id,e=this.job,f=this.id;if(!d||!f)throw new Error("Batch not started.");return e.info().then(function(a){return c._request({method:"GET",path:"/job/"+d+"/batch/"+f+"/result"})}).then(function(a){var h;if("query"===e.operation){c._conn,a["result-list"].result;h=a["result-list"].result,h=g.map(g.isArray(h)?h:[h],function(a){return{id:a,batchId:f,jobId:d}})}else h=g.map(a,function(a){return{id:a.Id||null,success:"true"===a.Success,errors:a.Error?[a.Error]:[]}});return b.emit("response",h),h}).fail(function(a){throw b.emit("error",a),a}).thenCall(a)},l.prototype.result=function(a){var b=this.job.id,c=this.id;if(!b||!c)throw new Error("Batch not started.");var d=new h.Parsable,e=d.stream("csv");this._bulk._request({method:"GET",path:"/job/"+b+"/batch/"+c+"/result/"+a}).stream().pipe(e);return d};var m=function(){m.super_.apply(this,arguments)};c(m,j),m.prototype.beforeSend=function(a){a.headers=a.headers||{},a.headers["X-SFDC-SESSION"]=this._conn.accessToken},m.prototype.isSessionExpired=function(a){return 400===a.statusCode&&/<exceptionCode>InvalidSessionId<\/exceptionCode>/.test(a.body)},m.prototype.hasErrorInResponseBody=function(a){return!!a.error},m.prototype.parseError=function(a){return{errorCode:a.error.exceptionCode,message:a.error.exceptionMessage}};var n=function(a){this._conn=a,this._logger=a._logger};n.prototype.pollInterval=1e3,n.prototype.pollTimeout=1e4,n.prototype._request=function(a,b){var c=this._conn;a=g.clone(a);var d=[c.instanceUrl,"services/async",c.version].join("/");a.url=d+a.path;var e={responseType:a.responseType};return delete a.path,delete a.responseType,new m(this._conn,e).request(a).thenCall(b)},n.prototype.load=function(a,b,c,d,e){var f=this;if(!a||!b)throw new Error("Insufficient arguments. At least, 'type' and 'operation' are required.");g.isObject(c)&&c.constructor===Object||(e=d,d=c,c=null);var h=this.createJob(a,b,c);h.once("error",function(a){i&&i.emit("error",a)});var i=h.createBatch(),j=function(){i=null,h.close()},k=function(a){"PollingTimeout"!==a.name&&j()};return i.on("response",j),i.on("error",k),i.on("queue",function(){i.poll(f.pollInterval,f.pollTimeout)}),i.execute(d,e)},n.prototype.query=function(a){var b=a.replace(/\([\s\S]+\)/g,"").match(/FROM\s+(\w+)/i);if(!b)throw new Error("No sobject type found in query, maybe caused by invalid SOQL.");var c=b[1],d=this,e=new h.Parsable,f=e.stream("csv");return this.load(c,"query",a).then(function(a){var b=a[0],c=d.job(b.jobId).batch(b.batchId).result(b.id);c.stream().pipe(f)}).fail(function(a){e.emit("error",a)}),e},n.prototype.createJob=function(a,b,c){return new k(this,a,b,c)},n.prototype.job=function(a){return new k(this,null,null,null,a)},b.exports=n}).call(this,a("_process"))},{_process:2}],2:[function(a,b,c){function d(){k=!1,h.length?j=h.concat(j):l=-1,j.length&&e()}function e(){if(!k){var a=setTimeout(d);k=!0;for(var b=j.length;b;){for(h=j,j=[];++l<b;)h[l].run();l=-1,b=j.length}h=null,k=!1,clearTimeout(a)}}function f(a,b){this.fun=a,this.array=b}function g(){}var h,i=b.exports={},j=[],k=!1,l=-1;i.nextTick=function(a){var b=new Array(arguments.length-1);if(arguments.length>1)for(var c=1;c<arguments.length;c++)b[c-1]=arguments[c];j.push(new f(a,b)),1!==j.length||k||setTimeout(e,0)},f.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=g,i.addListener=g,i.once=g,i.off=g,i.removeListener=g,i.removeAllListeners=g,i.emit=g,i.binding=function(a){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(a){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},{}]},{},[1])(1)});
//# sourceMappingURL=jsforce-api-bulk.min.js.map